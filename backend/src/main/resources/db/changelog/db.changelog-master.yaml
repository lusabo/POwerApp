databaseChangeLog:
  - changeSet:
      id: 1
      author: codex
      changes:
        - createTable:
            tableName: users
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: name
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: email
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: password_hash
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP
                  defaultValueComputed: "CURRENT_TIMESTAMP"
                  constraints:
                    nullable: false
              - column:
                  name: jira_api_token
                  type: VARCHAR(255)
              - column:
                  name: jira_api_email
                  type: VARCHAR(255)

  - changeSet:
      id: 2
      author: codex
      changes:
        - createTable:
            tableName: team_members
            columns:
              - column: {name: id, type: BIGSERIAL, constraints: {primaryKey: true}}
              - column: {name: name, type: VARCHAR(255), constraints: {nullable: false}}
              - column: {name: role, type: VARCHAR(255)}
              - column: {name: weekly_load, type: INT}
              - column:
                  name: user_id
                  type: BIGINT
                  constraints:
                    nullable: false
                    foreignKeyName: fk_team_member_user
                    references: users(id)

  - changeSet:
      id: 3
      author: codex
      changes:
        - createTable:
            tableName: domain_cycles
            columns:
              - column: {name: id, type: BIGSERIAL, constraints: {primaryKey: true}}
              - column: {name: name, type: VARCHAR(255), constraints: {nullable: false}}
              - column: {name: start_date, type: DATE, constraints: {nullable: false}}
              - column: {name: end_date, type: DATE, constraints: {nullable: false}}
              - column:
                  name: user_id
                  type: BIGINT
                  constraints:
                    nullable: false
                    foreignKeyName: fk_domain_cycle_user
                    references: users(id)

  - changeSet:
      id: 4
      author: codex
      changes:
        - createTable:
            tableName: sprints
            columns:
              - column: {name: id, type: BIGSERIAL, constraints: {primaryKey: true}}
              - column: {name: name, type: VARCHAR(255), constraints: {nullable: false}}
              - column: {name: start_date, type: DATE, constraints: {nullable: false}}
              - column: {name: end_date, type: DATE, constraints: {nullable: false}}
              - column: {name: capacity, type: INT}
              - column: {name: sp_completed, type: INT}
              - column:
                  name: domain_cycle_id
                  type: BIGINT
                  constraints:
                    foreignKeyName: fk_sprint_domain_cycle
                    references: domain_cycles(id)
              - column:
                  name: user_id
                  type: BIGINT
                  constraints:
                    nullable: false
                    foreignKeyName: fk_sprint_user
                    references: users(id)

  - changeSet:
      id: 5
      author: codex
      changes:
        - createTable:
            tableName: holidays
            columns:
              - column: {name: id, type: BIGSERIAL, constraints: {primaryKey: true}}
              - column: {name: description, type: VARCHAR(255), constraints: {nullable: false}}
              - column: {name: holiday_date, type: DATE, constraints: {nullable: false}}
              - column:
                  name: user_id
                  type: BIGINT
                  constraints:
                    nullable: false
                    foreignKeyName: fk_holiday_user
                    references: users(id)

  - changeSet:
      id: 6
      author: codex
      changes:
        - createTable:
            tableName: epics
            columns:
              - column: {name: id, type: BIGSERIAL, constraints: {primaryKey: true}}
              - column: {name: epic_key, type: VARCHAR(255), constraints: {nullable: false}}
              - column: {name: name, type: VARCHAR(255), constraints: {nullable: false}}
              - column:
                  name: user_id
                  type: BIGINT
                  constraints:
                    nullable: false
                    foreignKeyName: fk_epic_user
                    references: users(id)

  - changeSet:
      id: 7
      author: codex
      changes:
        - createTable:
            tableName: unplanned_items
            columns:
              - column: {name: id, type: BIGSERIAL, constraints: {primaryKey: true}}
              - column: {name: title, type: VARCHAR(255), constraints: {nullable: false}}
              - column: {name: story_points, type: INT}
              - column:
                  name: sprint_id
                  type: BIGINT
                  constraints:
                    nullable: false
                    foreignKeyName: fk_unplanned_sprint
                    references: sprints(id)
              - column:
                  name: user_id
                  type: BIGINT
                  constraints:
                    nullable: false
                    foreignKeyName: fk_unplanned_user
                    references: users(id)

  - changeSet:
      id: 8
      author: codex
      changes:
        - createTable:
            tableName: project_config
            columns:
              - column: {name: id, type: BIGSERIAL, constraints: {primaryKey: true}}
              - column: {name: project_name, type: VARCHAR(255)}
              - column: {name: jira_key, type: VARCHAR(255)}
              - column: {name: board, type: VARCHAR(255)}
              - column: {name: feature_team, type: VARCHAR(255)}
              - column:
                  name: user_id
                  type: BIGINT
                  constraints:
                    nullable: false
                    foreignKeyName: fk_project_config_user
                    references: users(id)
        - addUniqueConstraint:
            tableName: project_config
            columnNames: user_id
            constraintName: uq_project_config_user

  - changeSet:
      id: 10
      author: codex
      changes:
        - addColumn:
            tableName: project_config
            columns:
              - column:
                  name: board_id
                  type: BIGINT

  - changeSet:
      id: 11
      author: codex
      changes:
        - addColumn:
            tableName: sprints
            columns:
              - column:
                  name: jira_sprint_id
                  type: BIGINT

  - changeSet:
      id: 12
      author: codex
      changes:
        - dropColumn:
            columnName: weekly_load
            tableName: team_members

  - changeSet:
      id: 13
      author: codex
      changes:
        - addColumn:
            tableName: project_config
            columns:
              - column:
                  name: ceremonies_days
                  type: INT

  - changeSet:
      id: 14
      author: codex
      changes:
        - addColumn:
            tableName: epics
            columns:
              - column: {name: effort_size, type: VARCHAR(50)}
              - column: {name: issues_count, type: INT}
              - column: {name: story_points_sum, type: "DECIMAL(18,2)"}
              - column:
                  name: domain_cycle_id
                  type: BIGINT
                  constraints:
                    foreignKeyName: fk_epic_domain_cycle
                    references: domain_cycles(id)

  - changeSet:
      id: 15
      author: codex
      changes:
        - addColumn:
            tableName: sprints
            columns:
              - column: {name: operations_spikes_days, type: INT}
              - column: {name: working_days, type: INT}
              - column: {name: ceremony_days, type: INT}
              - column: {name: holiday_days, type: INT}
              - column: {name: net_capacity_days, type: INT}
              - column: {name: team_size, type: INT}
              - column: {name: absences_days, type: INT}
              - column: {name: capacity_total, type: INT}
              - column: {name: capacity_percent, type: "DECIMAL(10,4)"}
              - column: {name: capacity_final, type: INT}
              - column: {name: capacity_final_percent, type: "DECIMAL(10,4)"}

  - changeSet:
      id: 16
      author: codex
      changes:
        - createTable:
            tableName: sprint_absences
            columns:
              - column: {name: id, type: BIGSERIAL, constraints: {primaryKey: true}}
              - column: {name: sprint_id, type: BIGINT, constraints: {nullable: false}}
              - column: {name: team_member_id, type: BIGINT, constraints: {nullable: false}}
              - column: {name: days, type: INT}
        - addForeignKeyConstraint:
            baseTableName: sprint_absences
            baseColumnNames: sprint_id
            referencedTableName: sprints
            referencedColumnNames: id
            constraintName: fk_absence_sprint
        - addForeignKeyConstraint:
            baseTableName: sprint_absences
            baseColumnNames: team_member_id
            referencedTableName: team_members
            referencedColumnNames: id
            constraintName: fk_absence_member
